<?xml version="1.0" encoding="UTF-8"?>
<jobs>
    <job name="Temp Registry Users migration">
        <extractor>
            <connection>agcv5_user</connection>
            <query>
                <![CDATA[
                SELECT id as user_id, legacy_id
                FROM registry_user
            ]]>
            </query>
        </extractor>

        <transformer />

        <loader>
            <connection>default</connection>
            <entity>PartnerBundle\Entity\TempRegistryUser</entity>
        </loader>

        <mappings/>
    </job>

    <job name="Temp Partners Registry Users migration">
        <extractor>
            <connection>agcv4</connection>
            <query>
                <![CDATA[
                    SELECT
                        sys_user.contact_id
                        ,T2.id_company as partner_id
                    FROM ntw_company AS T2
                    INNER JOIN ntw_company_contact ON ntw_company_contact.company_id = T2.id_company
                    INNER JOIN sys_user ON sys_user.contact_id = ntw_company_contact.contact_id
                    INNER JOIN ntw_company_business AS T6 ON T2.id_company = T6.company_id
                    WHERE T6.ntw_contract_id IN (2270913, 2270914)
                    GROUP BY sys_user.contact_id, T2.id_company
                    ORDER BY partner_id ASC
                ]]>
            </query>
        </extractor>
        <transformer>
            <!-- nothing here -->
        </transformer>

        <loader>
            <connection>default</connection>
            <entity>PartnerBundle\Entity\TempPartnerRegistryUser</entity>
        </loader>

        <mappings>
            <mapping>
                <name>contact_id</name>
                <targetProperty>legacyUserId</targetProperty>
            </mapping>
            <mapping>
                <name>partner_id</name>
                <targetProperty>partner</targetProperty>
                <type>entity</type>
                <entityClass>PartnerBundle\Entity\Partner</entityClass>
                <referencedBy>legacyId</referencedBy>
            </mapping>
        </mappings>
    </job>

    <job name="Partners Registry Users migration">
        <extractor>
            <connection>default</connection>
            <query>
                <![CDATA[
                SELECT t1.partner_id, t2.user_id
                FROM temp_partner_registry_user t1
                INNER JOIN temp_registry_user t2
                    ON t2.legacy_id = t1.legacy_user_id
            ]]>
            </query>
        </extractor>

        <transformer />

        <loader>
            <connection>default</connection>
            <entity>PartnerBundle\Entity\PartnerRegistryUser</entity>
        </loader>

        <mappings>
            <mapping>
                <name>partner_id</name>
                <targetProperty>partner</targetProperty>
                <type>entity</type>
                <entityClass>PartnerBundle\Entity\Partner</entityClass>
                <referencedBy>id</referencedBy>
            </mapping>
            <mapping>
                <name>user_id</name>
                <targetProperty>registryUserId</targetProperty>
            </mapping>
        </mappings>
    </job>
</jobs>